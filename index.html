<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tool - Auto Save üíæ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* Settings Toggle */
        .settings-toggle-btn {
            background-color: #607d8b; color: white; padding: 10px; width: 100%; text-align: left;
            border: none; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .settings-toggle-btn:hover { background-color: #546e7a; }
        #settingsArea { display: none; margin-top: 15px; padding: 15px; background-color: #eceff1; border-radius: 5px; border: 1px solid #cfd8dc; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-box label { font-weight: bold; color: #37474f; display: block; margin-bottom: 8px; }
        
        input[type="text"], textarea { width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; box-sizing: border-box; }
        textarea.bank-area { height: 110px; resize: vertical; font-family: monospace; }
        input.firm-input { font-weight: bold; color: #333; font-size: 15px; }

        /* Input Section */
        .input-section { margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; }
        .raw-data-area { height: 100px; font-family: monospace; border: 2px solid #90caf9; }
        
        .btn-container { display: flex; gap: 10px; margin-top: 10px; }
        .gen-btn { flex: 2; background-color: #007bff; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .gen-btn:hover { background-color: #0056b3; }
        .clear-all-btn { flex: 1; background-color: #dc3545; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .clear-all-btn:hover { background-color: #c82333; }

        /* Table */
        .table-responsive { overflow-x: auto; padding-bottom: 100px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1250px; }
        th, td { border: 1px solid #ddd; padding: 8px; vertical-align: middle; }
        th { background-color: #343a40; color: white; padding: 12px; text-align: left; }

        /* Editable Fields */
        .edit-field { width: 100%; padding: 6px; border: 1px solid #aaa; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .edit-field:focus { border-color: #007bff; background-color: #fffde7; outline: none; }
        .inp-party { font-weight: 600; color: #333; }

        /* Buttons */
        .btn-group { display: flex; gap: 5px; }
        .wa-btn { background-color: #25D366; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; white-space: nowrap; flex: 1; }
        .wa-btn:hover { background-color: #1ebc57; transform: scale(1.02); }
        .del-btn { background-color: #ff5252; color: white; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; white-space: nowrap; }

        /* Save Indicator */
        #saveStatus { float: right; font-size: 12px; color: green; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Payment Follow-up Tool üöÄ <span id="saveStatus">Saved ‚úì</span></h2>

    <button class="settings-toggle-btn" onclick="toggleSettings()">
        <span>‚öôÔ∏è Edit Bank Details & Firm Name</span>
        <span>‚ñº</span>
    </button>

    <div id="settingsArea">
        <div class="settings-grid">
            <div class="settings-box">
                <label>Firm Name:</label>
                <input type="text" id="firmName" class="firm-input" value="RAVI KUMAR DEEPAK KUMAR" oninput="saveData()">
            </div>
            <div class="settings-box">
                <label>Bank Details:</label>
                <textarea id="bankDetails" class="bank-area" oninput="saveData()">üè¶ *Bank Details:*
Bank: SBI
A/c No: *32837750647*
IFSC: *SBIN0031978*

üì± UPI: *9887938518@YBL*</textarea>
            </div>
        </div>
    </div>

    <div class="input-section">
        <label style="font-weight:bold;">Tally Data ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:</label>
        <textarea id="rawData" class="raw-data-area" placeholder="Paste data here..."></textarea>
        <div class="btn-container">
            <button class="gen-btn" onclick="processData()">‚ûï Add to List</button>
            <button class="clear-all-btn" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <div id="outputArea" class="table-responsive"></div>
</div>

<script>
    // --- 1. Load Data on Page Start ---
    window.onload = function() {
        loadData(); // Load saved data
    };

    function toggleSettings() {
        var x = document.getElementById("settingsArea");
        x.style.display = (x.style.display === "block") ? "none" : "block";
    }

    function createTableHeader() {
        const outputDiv = document.getElementById('outputArea');
        if (!document.getElementById('mainTable')) {
            outputDiv.innerHTML = `
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 250px;">Party Name (Editable)</th>
                        <th style="width: 130px;">Mobile No</th>
                        <th style="width: 100px;">Bill Date</th>
                        <th style="width: 130px;">Bill No</th>
                        <th style="width: 100px;">Amount (‚Çπ)</th>
                        <th style="width: 70px;">Days</th>
                        <th style="width: 180px;">Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>`;
        }
    }

    // --- 2. Process Tally Data ---
    function processData() {
        const textArea = document.getElementById('rawData');
        const text = textArea.value;
        if (!text.trim()) { alert("Please paste data."); return; }

        const lines = text.split('\n');
        createTableHeader();
        const tableBody = document.getElementById('tableBody');
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            let currentParty = "Unknown"; // Logic reset per line group if needed, but assuming standard format

            // Check if line has Party Name (Simplified logic for block parsing would be better, but sticking to line-by-line for robustness with mixed data)
            // Note: In Tally paste, Party often comes on one line, transaction on next. 
            // Since we are iterating, we need to capture party from previous lines if needed.
            // However, based on previous logic:
            
            if (line.startsWith("Party :")) {
                let rawName = line.split("Party :")[1];
                window.tempParty = rawName.replace(/,+$/, '').trim(); // Store in temp variable
            }
            else if (line.includes("Dr") || line.includes("Cr")) {
                let cleanLine = line.replace(/\s+/g, ' ').trim();
                let parts = cleanLine.split(' ');
                
                if(parts.length >= 5) {
                    try {
                        let billDate = parts[0];
                        let billNo = parts[1];
                        let drIndex = parts.indexOf("Dr") > -1 ? parts.indexOf("Dr") : parts.indexOf("Cr");
                        let amount = parts[drIndex - 1];
                        let days = parts[parts.length - 1]; 
                        let partyName = window.tempParty || "Unknown"; // Use stored party

                        addTableRow(partyName, "", billDate, billNo, amount, days);
                    } catch (e) { console.log("Error line"); }
                }
            }
        }
        textArea.value = "";
        saveData(); // Save immediately after adding
    }

    // --- Helper to Add Row HTML ---
    function addTableRow(party, mobile, date, bill, amount, days) {
        const tableBody = document.getElementById('tableBody');
        let newRow = `<tr>
            <td><input type="text" class="edit-field inp-party" value="${party}" oninput="saveData()"></td>
            <td><input type="text" class="edit-field inp-mobile" value="${mobile}" placeholder="Mobile..." oninput="saveData()"></td>
            <td><input type="text" class="edit-field inp-date" value="${date}" oninput="saveData()"></td>
            <td><input type="text" class="edit-field inp-bill" value="${bill}" oninput="saveData()"></td>
            <td><input type="text" class="edit-field inp-amt" value="${amount}" oninput="saveData()"></td>
            <td class="days-val" style="color:red; font-weight:bold;">${days}</td>
            <td>
                <div class="btn-group">
                    <button onclick="sendWhatsApp(this)" class="wa-btn">WhatsApp ‚û§</button>
                    <button onclick="removeRow(this)" class="del-btn" title="Remove">‚ùå</button>
                </div>
            </td>
        </tr>`;
        tableBody.insertAdjacentHTML('beforeend', newRow);
    }

    // --- 3. SAVE DATA (LocalStorage) ---
    function saveData() {
        // Save Settings
        let firm = document.getElementById('firmName').value;
        let bank = document.getElementById('bankDetails').value;
        localStorage.setItem('savedFirmName', firm);
        localStorage.setItem('savedBankDetails', bank);

        // Save Table Data
        let rows = [];
        const tableBody = document.getElementById('tableBody');
        if(tableBody) {
            tableBody.querySelectorAll('tr').forEach(tr => {
                rows.push({
                    party: tr.querySelector('.inp-party').value,
                    mobile: tr.querySelector('.inp-mobile').value,
                    date: tr.querySelector('.inp-date').value,
                    bill: tr.querySelector('.inp-bill').value,
                    amount: tr.querySelector('.inp-amt').value,
                    days: tr.querySelector('.days-val').innerText
                });
            });
        }
        localStorage.setItem('savedTableData', JSON.stringify(rows));

        // Show 'Saved' indicator momentarily
        let status = document.getElementById('saveStatus');
        status.style.display = 'inline';
        setTimeout(() => { status.style.display = 'none'; }, 1000);
    }

    // --- 4. LOAD DATA (LocalStorage) ---
    function loadData() {
        // Load Settings
        if(localStorage.getItem('savedFirmName')) {
            document.getElementById('firmName').value = localStorage.getItem('savedFirmName');
        }
        if(localStorage.getItem('savedBankDetails')) {
            document.getElementById('bankDetails').value = localStorage.getItem('savedBankDetails');
        }

        // Load Table
        let savedRows = JSON.parse(localStorage.getItem('savedTableData') || '[]');
        if (savedRows.length > 0) {
            createTableHeader();
            savedRows.forEach(row => {
                addTableRow(row.party, row.mobile, row.date, row.bill, row.amount, row.days);
            });
        }
    }

    function clearAllData() {
        if(confirm("Are you sure? This will delete everything.")) {
            document.getElementById('outputArea').innerHTML = "";
            localStorage.removeItem('savedTableData'); // Only clear table, keep settings
            createTableHeader();
        }
    }

    function sendWhatsApp(btn) {
        let firmName = document.getElementById('firmName').value;
        let bankInfo = document.getElementById('bankDetails').value;
        let row = btn.closest('tr');
        
        let party = row.querySelector('.inp-party').value;
        let mobile = row.querySelector('.inp-mobile').value.replace(/\D/g, ''); 
        let date = row.querySelector('.inp-date').value;
        let bill = row.querySelector('.inp-bill').value;
        let amount = row.querySelector('.inp-amt').value;
        let days = row.querySelector('.days-val').innerText;

        let msg = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á *${party}*,\n\n‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§´‡§∞‡•ç‡§Æ *${firmName}* ‡§ï‡•Ä ‡§§‡§∞‡§´ ‡§∏‡•á ‡§Ø‡§π ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞ ‡§π‡•à‡•§\n\n‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ø‡§≤ ‡§®‡§Ç: *${bill}*\n‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${date}\n‡§∞‡§æ‡§∂‡§ø: *‚Çπ${amount}*\n\n‡§Ø‡§π ‡§≠‡•Å‡§ó‡§§‡§æ‡§® *${days} ‡§¶‡§ø‡§®‡•ã‡§Ç* ‡§∏‡•á ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡•Ä ‡§ó‡§à ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ ‡§™‡§∞ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç:\n\n------------------\n${bankInfo}\n------------------\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶,\n*${firmName}*`;

        let encodedMsg = encodeURIComponent(msg);
        if (mobile.length === 10) mobile = "91" + mobile;
        let url = (mobile.length >= 10) 
            ? `https://wa.me/${mobile}?text=${encodedMsg}` 
            : `https://wa.me/?text=${encodedMsg}`;
        window.open(url, '_blank');
    }

    function removeRow(btn) {
        let row = btn.closest('tr');
        row.remove();
        saveData(); // Save after deleting
    }
</script>

</body>
</html>
