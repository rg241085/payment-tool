<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Follow-up Tool (Realtime Firebase)</title>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        .settings-toggle-btn { background-color: #607d8b; color: white; padding: 10px; width: 100%; text-align: left; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #settingsArea { display: none; margin-top: 15px; padding: 15px; background-color: #eceff1; border-radius: 5px; border: 1px solid #cfd8dc; }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        textarea.bank-area { height: 110px; font-family: monospace; }

        .input-section { margin-top: 20px; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; }
        .raw-data-area { height: 100px; font-family: monospace; border: 2px solid #90caf9; }

        .btn-container { display: flex; gap: 10px; margin-top: 10px; }
        .gen-btn { flex: 2; background-color: #007bff; color: white; padding: 12px; border-radius: 5px; border: none; }
        .clear-all-btn { flex: 1; background-color: #dc3545; color: white; padding: 12px; border-radius: 5px; border: none; }

        .table-responsive { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1250px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #343a40; color: white; }

        .btn-group { display: flex; gap: 5px; }
        .wa-btn { background-color: #25D366; color: white; padding: 8px 12px; border-radius: 4px; border: none; }
        .del-btn { background-color: #ff5252; color: white; padding: 8px 12px; border-radius: 4px; border: none; }

        #saveStatus { color: green; font-size: 14px; font-weight: bold; display: none; float: right; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 350px; text-align: center; }
        .number-btn { width: 100%; padding: 12px; background: #25D366; color: white; border-radius: 5px; border: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Payment Follow-up Tool üöÄ <span id="saveStatus">Saved ‚úì</span></h2>

    <button class="settings-toggle-btn" onclick="toggleSettings()">
        <span>‚öôÔ∏è Edit Bank Details & Firm Name</span><span>‚ñº</span>
    </button>

    <div id="settingsArea">
        <div class="settings-grid">
            <div>
                <label>Firm Name</label>
                <input id="firmName" value="RAVI KUMAR DEEPAK KUMAR" oninput="saveSettings()">
            </div>
            <div>
                <label>Bank Details</label>
                <textarea id="bankDetails" class="bank-area" oninput="saveSettings()">üè¶ *Bank Details:* 
Bank: SBI 
A/c No: *32837750647* 
IFSC: *SBIN0031978*

üì± UPI: *9887938518@YBL*</textarea>
            </div>
        </div>
    </div>

    <div class="input-section">
        <label><b>Tally Data ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:</b></label>
        <textarea id="rawData" class="raw-data-area"></textarea>

        <div class="btn-container">
            <button class="gen-btn" onclick="processData()">‚ûï Add to List</button>
            <button class="clear-all-btn" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <div id="outputArea" class="table-responsive"></div>
</div>

<!-- Modal -->
<div id="numberModal" class="modal-overlay">
    <div class="modal-box">
        <h3>‡§ï‡§ø‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§∞ ‡§≠‡•á‡§ú‡§®‡§æ ‡§π‡•à?</h3>
        <div id="modalButtons"></div>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// -----------------------------------------------------
// 1) Firebase Config (Your config inserted here)
// -----------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDM92XNMKhzYTFWD323__5oVtLB2Y4gCAw",
  authDomain: "payment-3664c.firebaseapp.com",
  projectId: "payment-3664c",
  storageBucket: "payment-3664c.firebasestorage.app",
  messagingSenderId: "1051370161254",
  appId: "1:1051370161254:web:d45afdff0d4a3ca1e0d9a7",
  measurementId: "G-FBT5W16L2Z"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Firestore paths
const settingsDoc = db.collection("payment_meta").doc("settings");
const rowsCollection = db.collection("payment_meta").doc("workspace").collection("rows");

// -----------------------------------------------------
// Load settings realtime
// -----------------------------------------------------
window.onload = function () {
    loadSettingsRealtime();
    loadRowsRealtime();
};

// Settings realtime listener
function loadSettingsRealtime() {
    settingsDoc.onSnapshot(doc => {
        if (doc.exists) {
            let s = doc.data();
            document.getElementById("firmName").value = s.firm || "";
            document.getElementById("bankDetails").value = s.bank || "";
        }
    });
}

// Save settings
function saveSettings() {
    settingsDoc.set({
        firm: document.getElementById("firmName").value,
        bank: document.getElementById("bankDetails").value,
        updated: new Date()
    }, { merge: true });

    showSaved();
}

// -----------------------------------------------------
// Table maker
// -----------------------------------------------------
function makeTableIfNotExists() {
    if (!document.getElementById("mainTable")) {
        document.getElementById("outputArea").innerHTML = `
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Party</th>
                    <th>Mobile</th>
                    <th>Date</th>
                    <th>Bill</th>
                    <th>Amount</th>
                    <th>Days</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>`;
    }
}

// -----------------------------------------------------
// Add row to DOM
// -----------------------------------------------------
function addRowDOM(id, data) {
    makeTableIfNotExists();

    let row = document.querySelector(`tr[data-id='${id}']`);
    let html = `
    <tr data-id="${id}">
        <td><input data-f="party" value="${data.party}" oninput="updateRow('${id}','party', this.value)"></td>
        <td><input data-f="mobile" value="${data.mobile}" oninput="updateRow('${id}','mobile', this.value)"></td>
        <td><input data-f="date" value="${data.date}" oninput="updateRow('${id}','date', this.value)"></td>
        <td><input data-f="bill" value="${data.bill}" oninput="updateRow('${id}','bill', this.value)"></td>
        <td><input data-f="amount" value="${data.amount}" oninput="updateRow('${id}','amount', this.value)"></td>
        <td style="color:red; font-weight:bold;">${data.days}</td>
        <td>
            <button class="wa-btn" onclick="whatsappSend(this)">WhatsApp</button>
            <button class="del-btn" onclick="deleteRow('${id}')">‚ùå</button>
        </td>
    </tr>`;

    if (row) row.outerHTML = html;
    else document.getElementById("tableBody").insertAdjacentHTML("beforeend", html);
}

// -----------------------------------------------------
// Realtime listener for rows
// -----------------------------------------------------
function loadRowsRealtime() {
    rowsCollection.orderBy("created").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            let id = change.doc.id;
            let data = change.doc.data();

            if (change.type == "added" || change.type == "modified") {
                addRowDOM(id, data);
            } else if (change.type == "removed") {
                let row = document.querySelector(`tr[data-id='${id}']`);
                if (row) row.remove();
            }
        });
    });
}

// -----------------------------------------------------
// Update individual cell
// -----------------------------------------------------
function updateRow(id, field, value) {
    rowsCollection.doc(id).update({ [field]: value });
    showSaved();
}

// -----------------------------------------------------
// Process Tally
// -----------------------------------------------------
function processData() {
    let raw = document.getElementById("rawData").value.trim();
    if (!raw) return alert("Paste Tally data first");

    let lines = raw.split("\n");
    let tempParty = "";

    lines.forEach(line => {
        line = line.trim();
        if (line.startsWith("Party :")) {
            tempParty = line.replace("Party :", "").trim();
        } else if (line.includes("Dr") || line.includes("Cr")) {
            let parts = line.replace(/\s+/g, " ").split(" ");
            let date = parts[0];
            let bill = parts[1];
            let drIndex = parts.findIndex(x => x == "Dr" || x == "Cr");
            let amount = parts[drIndex - 1];
            let days = parts[parts.length - 1];

            rowsCollection.add({
                party: tempParty,
                mobile: "",
                date: date,
                bill: bill,
                amount: amount,
                days: days,
                created: new Date()
            });
        }
    });

    document.getElementById("rawData").value = "";
    showSaved();
}

// -----------------------------------------------------
// Delete row
// -----------------------------------------------------
function deleteRow(id) {
    if (!confirm("Delete permanently?")) return;
    rowsCollection.doc(id).delete();
}

// -----------------------------------------------------
// Clear all rows
// -----------------------------------------------------
async function clearAllData() {
    if (!confirm("Delete ALL DATA?")) return;
    let snap = await rowsCollection.get();
    let batch = db.batch();
    snap.forEach(d => batch.delete(d.ref));
    await batch.commit();
    showSaved();
}

// -----------------------------------------------------
// WhatsApp Modal + Send
// -----------------------------------------------------
function whatsappSend(btn) {
    let tr = btn.closest("tr");
    let mobileText = tr.querySelector("input[data-f='mobile']").value;

    let nums = mobileText.split(/[^0-9]+/).filter(x => x.length >= 10);

    let data = {
        party: tr.querySelector("input[data-f='party']").value,
        date: tr.querySelector("input[data-f='date']").value,
        bill: tr.querySelector("input[data-f='bill']").value,
        amt: tr.querySelector("input[data-f='amount']").value,
        days: tr.children[5].innerText,
        firm: document.getElementById("firmName").value,
        bank: document.getElementById("bankDetails").value
    };

    if (nums.length > 1) {
        openModal(nums, data);
    } else {
        sendNow(nums[0], data);
    }
}

function sendNow(num, d) {
    let m = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á *${d.party}*,\n\n‡§Ü‡§™‡§ï‡§æ ‡§¨‡§ø‡§≤ *${d.bill}* ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï *${d.date}* ‡§∞‡§æ‡§∂‡§ø *‚Çπ${d.amt}* ${d.days} ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§∏‡•á ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§π‡•à‡•§\n\n${d.bank}\n\n‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶\n${d.firm}`;
    let url = `https://wa.me/91${num}?text=${encodeURIComponent(m)}`;
    window.open(url, "_blank");
    closeModal();
}

function openModal(list, data) {
    document.getElementById("modalButtons").innerHTML = "";
    list.forEach(n => {
        let b = document.createElement("button");
        b.className = "number-btn";
        b.innerText = n;
        b.onclick = () => sendNow(n, data);
        document.getElementById("modalButtons").appendChild(b);
    });
    document.getElementById("numberModal").style.display = "flex";
}

function closeModal() {
    document.getElementById("numberModal").style.display = "none";
}

// -----------------------------------------------------
function toggleSettings() {
    let s = document.getElementById("settingsArea");
    s.style.display = s.style.display === "block" ? "none" : "block";
}

function showSaved() {
    let x = document.getElementById("saveStatus");
    x.style.display = "inline";
    setTimeout(() => x.style.display = "none", 1000);
}
</script>

</body>
</html>
